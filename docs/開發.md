# Linux.do 貼圖化插件 - 開發文檔

## 代碼庫結構

- **主文件**: `a.js` (約 26000+ 行)
- **配置**: 使用 localStorage 存儲
- **架構**: 單文件 JavaScript 用戶腳本

---

## 核心模塊索引

### 1. 數據存儲模塊 (localStorage)

**位置**: 第 22560-22690 行

**關鍵函數**:
- `loadDataFromLocalStorage()` - 從 localStorage 加載數據
- `loadDataFromLocalStorageAsync()` - 異步加載數據
- `saveDataToLocalStorage(data)` - 保存數據到 localStorage

**存儲鍵**:
- `STORAGE_KEY` - 存儲表情分組數據
- `SETTINGS_KEY` - 存儲設置數據

**數據結構**:
```javascript
{
  emojiGroups: [
    {
      id: "group-id",
      name: "分組名稱",
      icon: "📁",
      emojis: [
        {
          id: "emoji-id",
          name: "表情名稱",
          url: "https://...",
          packet: 1234567890,
          width: 100,  // 可選
          height: 100  // 可選
        }
      ]
    }
  ],
  settings: {
    imageScale: 30,
    gridColumns: 4,
    outputFormat: "markdown",
    forceMobileMode: false,
    defaultGroup: "nachoneko",
    showSearchBar: true,
    enableFloatingPreview: true,
    enableCalloutSuggestions: true
  }
}
```

---

### 2. 圖片/GIF 解析模塊

#### 2.1 圖片解析 (lightbox-wrapper)

**位置**: 第 22882-22900 行

**函數**: `extractEmojiDataFromLightboxWrapper(lightboxWrapper)`

**功能**:
- 從 `.lightbox-wrapper` 容器中提取圖片信息
- 支持 `.webp`, `.jpg`, `.jpeg`, `.png`, `.gif` 格式

**HTML 結構**:
```html
<div class="lightbox-wrapper">
  <a class="lightbox" href="原始URL" title="標題" data-download-href="下載URL">
    <img src="縮圖URL" alt="替代文字">
  </a>
</div>
```

#### 2.2 GIF 解析 (pausable-animated-image)

**位置**: 第 22911-22926 行

**函數**: `extractEmojiDataFromAnimatedImage(animatedImageDiv)`

**功能**:
- 從 `.pausable-animated-image` 容器中提取 GIF 信息
- 只處理 `.gif` 結尾的 URL
- 在 Console 輸出解析結果

**HTML 結構**:
```html
<div class="pausable-animated-image paused-animated-image">
  <canvas width="153" height="150"></canvas>
  <img src="https://...gif" alt="AgADvRUAArYmeFc.gif" class="animated manually-paused">
  <div class="animated-image-overlay">...</div>
</div>
```

#### 2.3 URL 名稱提取

**位置**: 第 22901-22910 行

**函數**: `extractNameFromUrl(url)`

**功能**:
- 從 URL 中提取文件名作為表情名稱
- 過濾純哈希值文件名
- 解碼 URL 編碼的字符

---

### 3. 批量添加按鈕模塊

#### 3.1 按鈕創建

**位置**: 第 23040-23168 行

**函數**: `createBatchParseButton(cookedElement)`

**功能**:
- 創建「一鍵解析並添加所有圖片」按鈕
- 解析當前內容中的所有圖片和 GIF
- 批量添加到用戶表情分組

**按鈕樣式**:
- 橙色漸變背景 (`#f59e0b` → `#d97706`)
- 懸停時變深色
- 處理中顯示灰色
- 成功顯示綠色
- 失敗顯示紅色

**解析流程**:
1. 查找所有 `.lightbox-wrapper` (圖片)
2. 查找所有 `.pausable-animated-image` (GIF)
3. 合併解析結果
4. 批量添加到 localStorage
5. 顯示處理結果

#### 3.2 按鈕顯示邏輯

**位置**: 第 23170-23178 行

**函數**: `processCookedContent(cookedElement)`

**顯示條件**:
- 內容中有 `.lightbox-wrapper` (圖片) **或**
- 內容中有 `.pausable-animated-image` (GIF)

**防重複**:
- 檢查是否已存在 `.emoji-batch-parse-button`

#### 3.3 內容監聽

**位置**: 第 23179-23188 行

**函數**: `processCookedContents()`

**功能**:
- 遍歷所有 `.cooked` 元素
- 檢查是否有圖片或 GIF
- 為符合條件的內容添加按鈕

**位置**: 第 23189-23203 行

**函數**: `initBatchParseButtons()`

**功能**:
- 初始化時處理現有內容
- 使用 MutationObserver 監聽新內容
- 自動為新內容添加按鈕

---

### 4. 表情添加模塊

**位置**: 第 22700-22740 行

**函數**: `addEmojiToUserscript(emojiData)`

**功能**:
- 添加表情到用戶分組
- 檢查 URL 重複
- 生成唯一的 packet ID
- 保存到 localStorage

**參數**:
```javascript
{
  name: "表情名稱",
  url: "https://..."
}
```

**用戶分組**:
- 固定 ID: `"user"`
- 固定名稱: `"用户表情"`
- 固定圖標: `"👤"`

---

### 5. 懸浮預覽模塊

#### 5.1 預覽窗創建

**位置**: 第 23655-23673 行

**函數**: `ensureHoverPreview()`

**功能**:
- 創建全局共享的懸浮預覽窗
- 包含圖片和標籤
- 固定在頁面上方 (z-index: 1000002)

**樣式**:
- 毛玻璃效果 (`backdrop-filter: blur(10px)`)
- 圓角邊框
- 陰影效果
- 最大尺寸: 320x320px

#### 5.2 預覽窗樣式

**位置**: 第 23742-23773 行

**CSS 類**: `.emoji-picker-hover-preview`

**主題支持**:
- 亮色主題: 白色背景
- 暗色主題: 深色背景 (`rgba(32,33,36,0.94)`)

#### 5.3 預覽窗行為

**位置**: 第 25787-25829 行 和 第 26027-26069 行

**事件綁定**:
- `mouseenter` - 顯示預覽窗
- `mousemove` - 跟隨鼠標移動
- `mouseleave` - 隱藏預覽窗

**自動隱藏**:
- 停留時間: **1 秒** (`1e3` 毫秒)
- 淡出動畫: 300 毫秒
- 使用 `fadeTimer` 控制

**位置計算**:
- 默認顯示在鼠標右下方
- 超出視窗時自動調整到左上方
- 邊距: 12px

---

### 6. 添加按鈕模塊 (單個圖片)

**位置**: 第 22911-23000 行

**函數**: `createAddButton(emojiData)`

**功能**:
- 為單個圖片創建「添加表情」按鈕
- 點擊後添加到用戶表情
- 顯示添加狀態 (成功/失敗)

**按鈕樣式**:
- 紫色漸變背景 (`#4f46e5` → `#7c3aed`)
- 白色邊框
- 懸停時放大效果

---

### 7. 狀態管理模塊

**位置**: 第 22826-22842 行

**全局狀態**: `userscriptState`

**結構**:
```javascript
{
  emojiGroups: [],
  settings: { ... },
  emojiUsageStats: {},
  fullSizeMode: false,
  batchAddMode: false  // 批量添加模式標誌
}
```

**批量添加模式**:
- 啟用時暫時禁用事件觸發
- 避免批量添加時的性能問題

---

## 開發技巧

### 搜索關鍵字

根據功能需求,可以使用以下關鍵字搜索代碼:

| 功能 | 搜索關鍵字 |
|------|-----------|
| 圖片解析 | `extractEmojiDataFromLightboxWrapper`, `lightbox-wrapper` |
| GIF 解析 | `extractEmojiDataFromAnimatedImage`, `pausable-animated-image`, `.gif` |
| 批量添加 | `createBatchParseButton`, `批量添加`, `一鍵解析` |
| 添加表情 | `addEmojiToUserscript`, `localStorage` |
| 懸浮預覽 | `ensureHoverPreview`, `hover-preview`, `fadeTimer` |
| 按鈕顯示 | `processCookedContent`, `.cooked` |
| 數據存儲 | `loadDataFromLocalStorage`, `saveDataToLocalStorage` |

### Console 調試

代碼中包含大量 Console 輸出,方便調試:

```javascript
console.log("[批量添加] 找到", count, "個 lightbox-wrapper");
console.log("[批量添加] 找到", count, "個 pausable-animated-image (GIF)");
console.log("[GIF 解析] 找到 GIF:", { name, url });
console.log("[批量添加] 圖片/GIF 列表:", allEmojiData);
```

### 修改時間設置

| 設置 | 位置 | 當前值 | 說明 |
|------|------|--------|------|
| 懸浮預覽停留時間 | 25799, 26039 行 | `1e3` (1秒) | 修改 `setTimeout` 的第二個參數 |
| 淡出動畫時間 | 25801, 26041 行 | `300` (0.3秒) | 修改內層 `setTimeout` 的參數 |
| 按鈕成功提示時間 | 23147 行 | `3e3` (3秒) | 修改 `setTimeout` 的參數 |

---

## 常見修改場景

### 1. 添加新的圖片容器支持

**步驟**:
1. 找到 `createBatchParseButton` 函數 (第 23040 行)
2. 添加新的 `querySelectorAll` 查詢
3. 創建對應的解析函數 (參考 `extractEmojiDataFromAnimatedImage`)
4. 將結果添加到 `allEmojiData` 數組

### 2. 修改按鈕樣式

**位置**: 第 23056-23070 行

修改 `button` 的 `style` 屬性和 `innerHTML`

### 3. 修改懸浮預覽時間

**位置**: 第 25799 行和第 26039 行

修改 `setTimeout` 的第二個參數 (單位: 毫秒)

### 4. 修改數據存儲結構

**位置**: 第 22560-22690 行

修改 `loadDataFromLocalStorage` 和 `saveDataToLocalStorage` 函數

### 5. 添加新的表情分組

**位置**: 第 22700-22740 行

修改 `addEmojiToUserscript` 函數,支持自定義分組 ID

---

## 注意事項

1. **代碼是壓縮過的**: 變量名可能不直觀,需要根據上下文理解
2. **單文件架構**: 所有功能都在一個文件中,修改時注意不要影響其他模塊
3. **localStorage 限制**: 注意存儲大小限制 (通常 5-10MB)
4. **性能考慮**: 批量操作時使用 `batchAddMode` 標誌避免重複觸發事件
5. **主題支持**: 使用 CSS 變量支持亮色/暗色主題
6. **防重複**: 添加表情時檢查 URL 是否已存在

---

## 更新歷史

### 2025-01-19
- 新增 GIF 解析支持
- 優化按鈕顯示邏輯
- 縮短懸浮預覽停留時間 (5秒 → 1秒)
