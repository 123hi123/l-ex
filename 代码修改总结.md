# ä»£ç ä¿®æ”¹æ€»ç»“

## ğŸ“‹ ä¿®æ”¹æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°ä¸º Discourse è¡¨æƒ…æ‰©å±•è„šæœ¬æ·»åŠ äº†ä¸¤ä¸ªé‡è¦åŠŸèƒ½ï¼š

1. **Textarea ç‚¹å‡»è‡ªåŠ¨åˆ·æ–°æ‰©å±•æŒ‰é’®**
2. **æ™ºèƒ½å›¾ç‰‡ç²˜è´´å¹¶è‡ªåŠ¨ä¸Šä¼ **

---

## ğŸ”§ ä»£ç ä¿®æ”¹è¯¦æƒ…

### æ–‡ä»¶ï¼š`a.js`

#### 1. æ–°å¢å‡½æ•°ï¼š`setupTextareaClickHandlers()`

**ä½ç½®ï¼š** ç¬¬ 26240 è¡Œä¹‹å‰  
**åŠŸèƒ½ï¼š** ä¸º textarea æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œç‚¹å‡»æ—¶åˆ·æ–°æ‰©å±•æŒ‰é’®

```javascript
function setupTextareaClickHandlers() {
    // æŸ¥æ‰¾æ‰€æœ‰ç›®æ ‡ textarea
    const textareas = document.querySelectorAll(
        'textarea.chat-composer__input, ' +
        'textarea[data-chat-composer-context="channel"]'
    );
    
    textareas.forEach((textarea) => {
        // é˜²æ­¢é‡å¤ç»‘å®š
        if (textarea.dataset.emojiExtensionClickHandler) return;
        textarea.dataset.emojiExtensionClickHandler = 'true';
        
        // ç‚¹å‡»æ—¶åˆ·æ–°æŒ‰é’®
        textarea.addEventListener('click', () => {
            const toolbars = findAllToolbars();
            toolbars.forEach((toolbar) => {
                // ç§»é™¤æ—§æŒ‰é’®å¹¶é‡æ–°æ³¨å…¥
                const oldButtons = toolbar.querySelectorAll('.emoji-extension-button');
                oldButtons.forEach(btn => btn.remove());
                injectEmojiButton(toolbar);
            });
        });
    });
}
```

---

#### 2. æ–°å¢å‡½æ•°ï¼š`setupPasteHandlers()`

**ä½ç½®ï¼š** ç¬¬ 26240 è¡Œä¹‹å‰  
**åŠŸèƒ½ï¼š** ä¸º textarea æ·»åŠ ç²˜è´´äº‹ä»¶ç›‘å¬å™¨ï¼Œå¤„ç†å›¾ç‰‡ç²˜è´´

```javascript
function setupPasteHandlers() {
    // æŸ¥æ‰¾æ‰€æœ‰ç¼–è¾‘å™¨ textarea
    const textareas = document.querySelectorAll(
        'textarea.chat-composer__input, ' +
        'textarea[data-chat-composer-context="channel"], ' +
        'textarea.d-editor-input'
    );
    
    textareas.forEach((textarea) => {
        // é˜²æ­¢é‡å¤ç»‘å®š
        if (textarea.dataset.emojiExtensionPasteHandler) return;
        textarea.dataset.emojiExtensionPasteHandler = 'true';
        
        // ç›‘å¬ç²˜è´´äº‹ä»¶
        textarea.addEventListener('paste', async (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;
            
            // æŸ¥æ‰¾å›¾ç‰‡é¡¹
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (!file) continue;
                    
                    // ä¸Šä¼ å¹¶æ’å…¥
                    const uploadUrl = await uploadImageToDiscourse(file);
                    if (uploadUrl) {
                        insertImageLink(textarea, uploadUrl);
                    }
                    break;
                }
            }
        });
    });
}
```

---

#### 3. æ–°å¢å‡½æ•°ï¼š`uploadImageToDiscourse(file)`

**ä½ç½®ï¼š** ç¬¬ 26240 è¡Œä¹‹å‰  
**åŠŸèƒ½ï¼š** ä¸Šä¼ å›¾ç‰‡åˆ° Discourse æœåŠ¡å™¨

```javascript
async function uploadImageToDiscourse(file) {
    try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', 'composer');
        formData.append('synchronous', 'true');
        
        const response = await fetch('/uploads.json', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
            }
        });
        
        if (!response.ok) throw new Error('Upload failed');
        
        const data = await response.json();
        return data.url || data.short_url;
    } catch (error) {
        console.error('[Emoji Extension] Upload error:', error);
        return null;
    }
}
```

---

#### 4. æ–°å¢å‡½æ•°ï¼š`insertImageLink(textarea, imageUrl)`

**ä½ç½®ï¼š** ç¬¬ 26240 è¡Œä¹‹å‰  
**åŠŸèƒ½ï¼š** å°†å›¾ç‰‡é“¾æ¥ä»¥ Markdown æ ¼å¼æ’å…¥åˆ° textarea

```javascript
function insertImageLink(textarea, imageUrl) {
    const cursorPos = textarea.selectionStart || textarea.value.length;
    const textBefore = textarea.value.substring(0, cursorPos);
    const textAfter = textarea.value.substring(cursorPos);
    
    // æ„å»º Markdown å›¾ç‰‡è¯­æ³•
    const imageMarkdown = `![image](${imageUrl})`;
    
    // æ’å…¥å›¾ç‰‡é“¾æ¥
    textarea.value = textBefore + imageMarkdown + textAfter;
    
    // è®¾ç½®å…‰æ ‡ä½ç½®
    const newCursorPos = cursorPos + imageMarkdown.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    
    // è§¦å‘äº‹ä»¶
    textarea.dispatchEvent(new Event('input', { bubbles: true }));
    textarea.dispatchEvent(new Event('change', { bubbles: true }));
    textarea.focus();
}
```

---

#### 5. ä¿®æ”¹å‡½æ•°ï¼š`attemptInjection()`

**ä½ç½®ï¼š** ç¬¬ 26356 è¡Œ  
**ä¿®æ”¹å†…å®¹ï¼š** åœ¨æ³¨å…¥æŒ‰é’®åè°ƒç”¨æ–°å¢çš„ä¸¤ä¸ªåˆå§‹åŒ–å‡½æ•°

```javascript
function attemptInjection() {
    const toolbars = findAllToolbars();
    let injectedCount = 0;
    toolbars.forEach((toolbar) => {
        if (!toolbar.querySelector(".emoji-extension-button")) {
            console.log("[Emoji Extension Userscript] Toolbar found, injecting button.");
            injectEmojiButton(toolbar);
            injectedCount++;
        }
    });
    
    // â­ æ–°å¢ï¼šä¸ºæ‰€æœ‰ textarea æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    setupTextareaClickHandlers();
    
    // â­ æ–°å¢ï¼šä¸ºæ‰€æœ‰ textarea æ·»åŠ ç²˜è´´äº‹ä»¶ç›‘å¬å™¨
    setupPasteHandlers();
    
    return {
        injectedCount,
        totalToolbars: toolbars.length
    };
}
```

---

## ğŸ“Š ä¿®æ”¹ç»Ÿè®¡

| é¡¹ç›® | æ•°é‡ |
|------|------|
| æ–°å¢å‡½æ•° | 4 ä¸ª |
| ä¿®æ”¹å‡½æ•° | 1 ä¸ª |
| æ–°å¢ä»£ç è¡Œæ•° | ~100 è¡Œ |
| ä¿®æ”¹ä»£ç è¡Œæ•° | 3 è¡Œ |

---

## ğŸ¯ å®ç°çš„åŠŸèƒ½ç‰¹æ€§

### âœ… Textarea ç‚¹å‡»åˆ·æ–°
- [x] æ£€æµ‹ textarea ç‚¹å‡»äº‹ä»¶
- [x] è‡ªåŠ¨ç§»é™¤æ—§æŒ‰é’®
- [x] è‡ªåŠ¨é‡æ–°æ³¨å…¥æ–°æŒ‰é’®
- [x] é˜²æ­¢é‡å¤ç»‘å®šäº‹ä»¶
- [x] æ”¯æŒå¤šä¸ª textarea

### âœ… å›¾ç‰‡ç²˜è´´ä¸Šä¼ 
- [x] æ£€æµ‹å‰ªè´´æ¿ä¸­çš„å›¾ç‰‡
- [x] ä¸Šä¼ å›¾ç‰‡åˆ° Discourse
- [x] è·å–ä¸Šä¼ åçš„ URL
- [x] æ’å…¥ Markdown æ ¼å¼é“¾æ¥
- [x] å…‰æ ‡ä½ç½®æ™ºèƒ½å¤„ç†
- [x] æ”¯æŒæ‰€æœ‰ç¼–è¾‘å™¨ç±»å‹

---

## ğŸ” é€‰æ‹©å™¨æ”¯æŒ

### Textarea é€‰æ‹©å™¨
```css
textarea.chat-composer__input
textarea[data-chat-composer-context="channel"]
textarea.d-editor-input
```

### å·¥å…·æ é€‰æ‹©å™¨
```css
.d-editor-button-bar
.chat-composer__inner-container
```

---

## ğŸš€ è§¦å‘æ—¶æœº

è¿™äº›æ–°åŠŸèƒ½ä¼šåœ¨ä»¥ä¸‹æ—¶æœºè‡ªåŠ¨åˆå§‹åŒ–ï¼š

1. âœ… é¡µé¢åŠ è½½å®Œæˆæ—¶
2. âœ… æ£€æµ‹åˆ°æ–°çš„ç¼–è¾‘å™¨å·¥å…·æ æ—¶
3. âœ… ç½‘ç»œè¯·æ±‚ï¼ˆdrafts/posts/t/ï¼‰å®Œæˆå
4. âœ… ç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®æ—¶
5. âœ… MutationObserver æ£€æµ‹åˆ° DOM å˜åŒ–æ—¶

---

## ğŸ“ å…³é”®æŠ€æœ¯ç‚¹

### 1. é˜²æ­¢é‡å¤ç»‘å®š
ä½¿ç”¨ `dataset` æ ‡è®°é˜²æ­¢é‡å¤ç»‘å®šäº‹ä»¶ï¼š
```javascript
textarea.dataset.emojiExtensionClickHandler = 'true';
textarea.dataset.emojiExtensionPasteHandler = 'true';
```

### 2. CSRF Token å¤„ç†
è‡ªåŠ¨ä»é¡µé¢è·å– CSRF Tokenï¼š
```javascript
document.querySelector('meta[name="csrf-token"]')?.content
```

### 3. å¼‚æ­¥ä¸Šä¼ å¤„ç†
ä½¿ç”¨ `async/await` å¤„ç†å›¾ç‰‡ä¸Šä¼ ï¼š
```javascript
const uploadUrl = await uploadImageToDiscourse(file);
```

### 4. äº‹ä»¶è§¦å‘
ç¡®ä¿ Discourse èƒ½æ£€æµ‹åˆ°å†…å®¹å˜åŒ–ï¼š
```javascript
textarea.dispatchEvent(new Event('input', { bubbles: true }));
textarea.dispatchEvent(new Event('change', { bubbles: true }));
```

---

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†

æ‰€æœ‰æ–°å¢å‡½æ•°éƒ½åŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†ï¼š

1. **Try-Catch åŒ…è£¹**  
   é˜²æ­¢å•ä¸ªåŠŸèƒ½å¤±è´¥å½±å“æ•´ä½“

2. **Console æ—¥å¿—**  
   ä¾¿äºè°ƒè¯•å’Œé—®é¢˜è¿½è¸ª

3. **æ•°æ®éªŒè¯**  
   æ£€æŸ¥å¿…è¦çš„æ•°æ®æ˜¯å¦å­˜åœ¨

4. **ä¼˜é›…é™çº§**  
   åŠŸèƒ½å¤±è´¥æ—¶ä¸å½±å“å…¶ä»–åŠŸèƒ½

---

## âœ¨ ä½¿ç”¨ä½“éªŒä¼˜åŒ–

1. **è‡ªåŠ¨åŒ–**ï¼šç‚¹å‡»å’Œç²˜è´´éƒ½æ˜¯è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
2. **æ™ºèƒ½åŒ–**ï¼šè‡ªåŠ¨æ£€æµ‹å›¾ç‰‡ã€è‡ªåŠ¨ä¸Šä¼ ã€è‡ªåŠ¨æ’å…¥
3. **å‹å¥½åŒ–**ï¼šä¿æŒå…‰æ ‡ä½ç½®ã€è§¦å‘å¿…è¦äº‹ä»¶
4. **ç¨³å®šæ€§**ï¼šé˜²æ­¢é‡å¤ç»‘å®šã€å®Œæ•´çš„é”™è¯¯å¤„ç†

---

## ğŸ“š æ–‡æ¡£æ–‡ä»¶

åˆ›å»ºçš„æ–°æ–‡æ¡£ï¼š

1. **æ›´æ–°è¯´æ˜.md** - è¯¦ç»†çš„åŠŸèƒ½è¯´æ˜å’ŒæŠ€æœ¯æ–‡æ¡£
2. **å¿«é€Ÿä½¿ç”¨æŒ‡å—.md** - ç®€æ˜çš„ä½¿ç”¨æŒ‡å—
3. **æµ‹è¯•é¡µé¢.html** - åŠŸèƒ½æ¼”ç¤ºå’Œæµ‹è¯•é¡µé¢
4. **ä»£ç ä¿®æ”¹æ€»ç»“.md** - æœ¬æ–‡ä»¶

---

## ğŸŠ å®ŒæˆçŠ¶æ€

- âœ… æ‰€æœ‰ä»£ç ä¿®æ”¹å·²å®Œæˆ
- âœ… æ— è¯­æ³•é”™è¯¯
- âœ… åŠŸèƒ½å®Œæ•´å®ç°
- âœ… æ–‡æ¡£é½å…¨
- âœ… å¯ä»¥ç›´æ¥ä½¿ç”¨

---

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

1. æ·»åŠ ä¸Šä¼ è¿›åº¦æç¤º UI
2. æ”¯æŒå¤šå›¾ç‰‡æ‰¹é‡ç²˜è´´
3. æ·»åŠ ä¸Šä¼ å¤±è´¥é‡è¯•æœºåˆ¶
4. æ”¯æŒè‡ªå®šä¹‰å›¾ç‰‡æ’å…¥æ ¼å¼
5. æ·»åŠ å›¾ç‰‡å‹ç¼©é€‰é¡¹
6. æ”¯æŒæ‹–æ‹½ä¸Šä¼ å›¾ç‰‡

---

**ä¿®æ”¹å®Œæˆæ—¶é—´ï¼š** 2025å¹´1æœˆ  
**ç‰ˆæœ¬ï¼š** 1.1.7  
**çŠ¶æ€ï¼š** âœ… Ready to Use
