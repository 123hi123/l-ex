# Linux.do 贴图化插件# Discourse 表情扩展 - 更新包



## 使用方法## 📦 内容概览



**步骤一**本次更新为您的 Discourse 表情扩展脚本添加了两个强大的新功能：



找到项目中的 `a.js` 文件，打开后将里面的内容全部复制起来。### 🎯 新增功能



**步骤二**1. **📍 Textarea 点击自动刷新**  

   点击编辑器时自动刷新三个扩展按钮（🐈‍⬛ ⭐ ⎘）

找到自己的油猴插件（任何类型的油猴插件都可以，例如 Tampermonkey、Violentmonkey、Greasemonkey），然后把代码粘贴上去。

2. **🖼️ 智能图片粘贴**  

**步骤三**   粘贴图片自动上传到 Discourse 并插入 Markdown 链接



如果功能不正常的话，可以换到暴力猴 (Violentmonkey) 看看。如果还是不正常，就可以提 Issue 给我：https://github.com/123hi123/l-ex/issues---


## 📁 文件说明

```
l ex/
├── a.js                    # ✅ 已修改 - 主脚本文件
├── 更新说明.md              # 📖 详细的功能说明和技术文档
├── 快速使用指南.md          # 🚀 简明的使用教程
├── 代码修改总结.md          # 🔧 代码修改的详细说明
├── 测试页面.html            # 🧪 功能演示和测试页面
└── README.md               # 📋 本文件
```

---

## ⚡ 快速开始

### 1. 安装/更新脚本

如果您已经安装了旧版本：
1. 在 Tampermonkey/Greasemonkey 中找到 "Discourse 表情扩展"
2. 替换为更新后的 `a.js` 文件内容
3. 保存并刷新 Discourse 页面

如果是首次安装：
1. 安装 Tampermonkey 浏览器扩展
2. 创建新脚本
3. 复制 `a.js` 的全部内容
4. 保存并访问 Discourse 论坛

### 2. 测试功能

#### 测试点击刷新：
```
1. 打开 Discourse 论坛
2. 进入任意编辑器
3. 点击 textarea 输入框
4. 观察工具栏按钮自动刷新
```

#### 测试图片粘贴：
```
1. 截取或复制一张图片
2. 在 Discourse 编辑器中粘贴（Ctrl+V）
3. 等待上传完成
4. 图片链接自动插入
```

---

## 📖 文档导航

### 🎯 我想要...

| 需求 | 查看文档 |
|------|---------|
| 快速了解如何使用 | [快速使用指南.md](快速使用指南.md) |
| 了解详细功能和技术细节 | [更新说明.md](更新说明.md) |
| 查看代码修改内容 | [代码修改总结.md](代码修改总结.md) |
| 在浏览器中查看演示 | [测试页面.html](测试页面.html) |

---

## 🔍 功能详细说明

### 功能 1️⃣：Textarea 点击自动刷新

**触发条件：** 点击 textarea 输入框

**刷新内容：**
- 🐈‍⬛ 表情包按钮
- ⭐ 常用表情按钮
- ⎘ 快捷输入按钮

**适用场景：**
- 按钮消失或未显示
- 切换编辑器后
- 需要确保按钮可用

**实现原理：**
```javascript
// 监听 textarea 点击
textarea.addEventListener('click', () => {
    // 移除旧按钮
    removeOldButtons();
    // 重新注入新按钮
    injectNewButtons();
});
```

---

### 功能 2️⃣：智能图片粘贴

**触发条件：** 在 textarea 中粘贴图片

**处理流程：**
```
粘贴图片 → 检测图片 → 上传到服务器 → 获取URL → 插入Markdown
```

**插入格式：**
```markdown
![image](https://your-discourse.com/uploads/xxx.jpg)
```

**支持的图片来源：**
- ✅ 截图工具（如 Snipping Tool, Snagit）
- ✅ 图片文件复制
- ✅ 浏览器中复制的图片
- ✅ 其他应用中复制的图片

**实现原理：**
```javascript
// 监听粘贴事件
textarea.addEventListener('paste', async (e) => {
    // 检测图片
    if (hasImage(e.clipboardData)) {
        // 上传图片
        const url = await uploadImage(image);
        // 插入链接
        insertMarkdown(textarea, url);
    }
});
```

---

## ⚙️ 技术特性

### 🛡️ 安全性
- ✅ CSRF Token 自动获取
- ✅ 使用 Discourse 官方 API
- ✅ 完整的错误处理

### 🚀 性能
- ✅ 防止重复绑定事件
- ✅ 异步上传不阻塞界面
- ✅ 智能检测减少不必要操作

### 🔧 兼容性
- ✅ Chrome/Edge ≥ 90
- ✅ Firefox ≥ 88
- ✅ Safari ≥ 14
- ✅ 所有 Discourse 标准编辑器

---

## 🎨 支持的编辑器

| 编辑器类型 | 支持状态 |
|-----------|---------|
| 主题回复编辑器 | ✅ |
| Chat 聊天编辑器 | ✅ |
| 私信编辑器 | ✅ |
| 新建主题编辑器 | ✅ |
| 编辑帖子编辑器 | ✅ |

---

## 🐛 问题排查

### 图片粘贴不工作？

**检查清单：**
- [ ] 粘贴的是图片文件，不是图片链接
- [ ] 浏览器控制台没有错误
- [ ] 在支持的 Discourse 论坛中使用
- [ ] CSRF Token 正确（自动处理）

**解决方法：**
1. 打开浏览器控制台（F12）
2. 查看是否有错误信息
3. 尝试刷新页面重试

### 点击刷新不工作？

**检查清单：**
- [ ] 点击的是正确的 textarea
- [ ] 控制台显示事件已绑定
- [ ] 脚本已启用

**解决方法：**
1. 确认点击的是 textarea 本身，不是其他元素
2. 查看控制台日志：`[Emoji Extension] Click handler attached`
3. 尝试使用手动刷新菜单命令

---

## 📊 控制台日志

脚本运行时会输出以下日志帮助调试：

```javascript
// 成功绑定
[Emoji Extension] Click handler attached to textarea
[Emoji Extension] Paste handler attached to textarea

// 点击刷新
[Emoji Extension] Textarea clicked, refreshing extension buttons...

// 图片上传
[Emoji Extension] Uploading image...
[Emoji Extension] Image link inserted: https://...
```

---

## 🎯 使用示例

### 示例 1：快速插入截图

```
1. 使用截图工具截取屏幕
2. 在 Discourse 回复框中按 Ctrl+V
3. 等待 1-2 秒上传完成
4. 图片链接自动出现在编辑器中
```

### 示例 2：刷新工具栏按钮

```
1. 发现表情包按钮不见了
2. 点击一下 textarea 输入框
3. 按钮立即重新出现
```

### 示例 3：从文件管理器粘贴图片

```
1. 在文件管理器中右键图片 → 复制
2. 在 Discourse 编辑器中粘贴
3. 图片自动上传并插入
```

---

## 📈 版本历史

### v1.1.8 (Current) - Bug 修复版
- 🐛 修复：按钮重复创建问题
- 🐛 修复：图片粘贴功能不工作
- ✨ 改进：支持外层容器粘贴监听
- ✨ 改进：支持多种图片链接格式
- ✨ 改进：自动处理相对路径
- ✨ 改进：增强事件触发机制
- 📚 文档：添加 Bug 修复说明和测试指南

### v1.1.7
- ✨ 新增：Textarea 点击自动刷新功能
- ✨ 新增：智能图片粘贴并自动上传
- 🔧 优化：防止事件重复绑定
- 📚 文档：完整的使用文档和示例

### v1.1.6 (Previous)
- 基础表情包功能
- 常用表情功能
- 快捷输入功能

---

## 🔮 未来计划

- [ ] 图片上传进度提示
- [ ] 多图片批量粘贴
- [ ] 上传失败自动重试
- [ ] 自定义插入格式
- [ ] 图片自动压缩
- [ ] 拖拽上传支持

---

## 💬 反馈与支持

遇到问题或有建议？

1. 📖 先查看文档：
   - [快速使用指南.md](快速使用指南.md)
   - [更新说明.md](更新说明.md)

2. 🔍 检查控制台：
   - 打开 F12 查看错误日志
   - 确认功能是否正确初始化

3. 🧪 使用测试页面：
   - 打开 [测试页面.html](测试页面.html)
   - 查看功能演示

---

## ✅ 快速检查清单

安装完成后，请确认：

- [ ] 脚本在 Tampermonkey 中已启用
- [ ] 访问 Discourse 论坛（如 linux.do）
- [ ] 进入编辑器能看到三个按钮（🐈‍⬛ ⭐ ⎘）
- [ ] 点击 textarea 后按钮会刷新
- [ ] 粘贴图片能自动上传

如果全部勾选，恭喜您已成功安装并配置好所有功能！🎉

---

## 📝 许可证

MIT License - 详见原脚本说明

---

**最后更新：** 2025年1月  
**版本：** 1.1.7  
**状态：** ✅ 稳定可用

---

<div align="center">

**🎊 享受使用新功能！**

如有问题，请查看相关文档或控制台日志。

</div>
