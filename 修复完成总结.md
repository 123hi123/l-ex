# âœ… ä¿®å¤å®Œæˆæ€»ç»“

## ğŸ¯ æœ¬æ¬¡ä¿®å¤æ¦‚è¿°

ç‰ˆæœ¬ï¼š**v1.1.8**  
ä¿®å¤æ—¥æœŸï¼š**2025å¹´1æœˆ**  
çŠ¶æ€ï¼š**âœ… å·²å®Œæˆå¹¶æµ‹è¯•**

---

## ğŸ› ä¿®å¤çš„é—®é¢˜

### é—®é¢˜ 1ï¼šæŒ‰é’®é‡å¤åˆ›å»º âœ…

**ç—‡çŠ¶ï¼š**
- æ¯æ¬¡ç‚¹å‡» textareaï¼Œå¿«æ·è¾“å…¥æŒ‰é’®å’Œå…¶ä»–æŒ‰é’®ä¼šé‡å¤å‡ºç°
- å·¥å…·æ å‡ºç°å¤šä¸ªç›¸åŒçš„ ğŸˆâ€â¬› â­ â˜ æŒ‰é’®

**æ ¹æœ¬åŸå› ï¼š**
ç‚¹å‡»äº‹ä»¶ç›´æ¥ç§»é™¤å¹¶é‡æ–°åˆ›å»ºæŒ‰é’®ï¼Œæ²¡æœ‰æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
ä½¿ç”¨ `attemptInjection()` å‡½æ•°ï¼Œå®ƒä¼šè‡ªåŠ¨æ£€æŸ¥æŒ‰é’®æ˜¯å¦å·²å­˜åœ¨ã€‚

**ä¿®æ”¹ä»£ç ï¼š**
```javascript
// ä¿®æ”¹å‰ï¼š
textarea.addEventListener('click', () => {
    // ç›´æ¥ç§»é™¤å¹¶é‡æ–°åˆ›å»º âŒ
    oldButtons.forEach(btn => btn.remove());
    injectEmojiButton(toolbar);
});

// ä¿®æ”¹åï¼š
textarea.addEventListener('click', () => {
    setTimeout(() => {
        attemptInjection(); // æ™ºèƒ½æ£€æŸ¥ âœ…
    }, 50);
});
```

---

### é—®é¢˜ 2ï¼šå›¾ç‰‡ç²˜è´´ä¸å·¥ä½œ âœ…

**ç—‡çŠ¶ï¼š**
- å¤åˆ¶å›¾ç‰‡é“¾æ¥ç²˜è´´åï¼Œæ²¡æœ‰è½¬æ¢ä¸º Markdown æ ¼å¼
- åªæ˜¾ç¤ºåŸå§‹æ–‡æœ¬é“¾æ¥

**æ ¹æœ¬åŸå› ï¼š**
1. `getAsString()` å¼‚æ­¥è°ƒç”¨æ²¡æœ‰æ­£ç¡®å¤„ç†
2. æ²¡æœ‰ç›‘å¬å¤–å±‚å®¹å™¨
3. å›¾ç‰‡é“¾æ¥æ£€æµ‹ä¸å¤Ÿå…¨é¢

**è§£å†³æ–¹æ¡ˆï¼š**

#### 1. æ­£ç¡®å¤„ç†å¼‚æ­¥æ–‡æœ¬è·å–
```javascript
// ä¿®æ”¹å‰ï¼šâŒ æ— æ³•é˜»æ­¢é»˜è®¤ç²˜è´´è¡Œä¸º
item.getAsString((text) => {
    if (isImageUrl(text)) {
        insertImageLink(textarea, text);
    }
});

// ä¿®æ”¹åï¼šâœ… æ­£ç¡®çš„å¼‚æ­¥å¤„ç†
const text = await new Promise((resolve) => {
    item.getAsString((str) => resolve(str));
});

if (isImageUrl(text)) {
    e.preventDefault();
    insertImageLink(textarea, text.trim());
    return;
}
```

#### 2. æ·»åŠ å¤–å±‚å®¹å™¨ç›‘å¬
```javascript
// åŒæ—¶ç›‘å¬ textarea å’Œå¤–å±‚å®¹å™¨
const containers = document.querySelectorAll('.chat-composer__input-container');
containers.forEach((container) => {
    container.addEventListener('paste', (e) => {
        const textarea = container.querySelector('textarea');
        if (textarea) {
            handlePaste(e, textarea);
        }
    });
});
```

#### 3. æ›´å…¨é¢çš„é“¾æ¥æ£€æµ‹
```javascript
// æ”¯æŒå¤šç§æ ¼å¼
if (text && (
    text.match(/\.(jpg|jpeg|png|gif|webp|bmp)(\?.*)?$/i) ||  // å¸¦å‚æ•°
    text.includes('/uploads/') ||                             // ç›¸å¯¹è·¯å¾„
    text.match(/https?:\/\/.*\.(jpg|jpeg|png|gif|webp|bmp)/i) // å®Œæ•´URL
)) {
    // æ’å…¥å›¾ç‰‡
}
```

---

## ğŸ‰ æ–°å¢åŠŸèƒ½

### ç»Ÿä¸€çš„ç²˜è´´å¤„ç†å‡½æ•°

åˆ›å»ºäº† `handlePaste()` å‡½æ•°æ¥ç»Ÿä¸€å¤„ç†æ‰€æœ‰ç²˜è´´åœºæ™¯ï¼š

```javascript
async function handlePaste(e, textarea) {
    // 1. æ£€æµ‹å¹¶å¤„ç†å›¾ç‰‡é“¾æ¥ï¼ˆæ–‡æœ¬ï¼‰
    // 2. æ£€æµ‹å¹¶å¤„ç†å›¾ç‰‡æ–‡ä»¶
    // 3. æä¾›è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… ä»£ç å¤ç”¨
- âœ… é€»è¾‘ç»Ÿä¸€
- âœ… æ˜“äºç»´æŠ¤
- âœ… è°ƒè¯•æ–¹ä¾¿

### å¢å¼ºçš„æ’å…¥å‡½æ•°

æ”¹è¿›äº† `insertImageLink()` å‡½æ•°ï¼š

```javascript
function insertImageLink(textarea, imageUrl) {
    // 1. è‡ªåŠ¨å¤„ç†ç›¸å¯¹è·¯å¾„
    if (imageUrl.startsWith('/uploads/')) {
        fullUrl = window.location.origin + imageUrl;
    }
    
    // 2. æ™ºèƒ½æ·»åŠ æ¢è¡Œ
    if (textBefore && !textBefore.endsWith('\n')) {
        prefix = '\n';
    }
    
    // 3. è§¦å‘å¤šç§äº‹ä»¶ç¡®ä¿å…¼å®¹æ€§
    textarea.dispatchEvent(new Event('input', { bubbles: true }));
    textarea.dispatchEvent(new Event('change', { bubbles: true }));
    textarea.dispatchEvent(new KeyboardEvent('keyup', { bubbles: true }));
}
```

---

## ğŸ“Š ä»£ç å˜æ›´ç»Ÿè®¡

| é¡¹ç›® | æ•°é‡ |
|------|------|
| ä¿®æ”¹å‡½æ•° | 3 ä¸ª |
| æ–°å¢å‡½æ•° | 1 ä¸ª |
| ä¿®å¤ Bug | 2 ä¸ª |
| æ–°å¢æ—¥å¿— | 5 æ¡ |
| ä»£ç è¡Œæ•° | +80 è¡Œ |

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

### æµ‹è¯•é¡¹ç›®

| æµ‹è¯•é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| æŒ‰é’®ä¸é‡å¤ | âœ… | å¤šæ¬¡ç‚¹å‡»ä¸ä¼šé‡å¤åˆ›å»º |
| ç²˜è´´å®Œæ•´URL | âœ… | æ”¯æŒ https://... æ ¼å¼ |
| ç²˜è´´ç›¸å¯¹è·¯å¾„ | âœ… | è‡ªåŠ¨è¡¥å…¨åŸŸå |
| ç²˜è´´å›¾ç‰‡æ–‡ä»¶ | âœ… | è‡ªåŠ¨ä¸Šä¼ å¹¶æ’å…¥ |
| å¤–å±‚å®¹å™¨ç²˜è´´ | âœ… | æ”¯æŒå®¹å™¨çº§åˆ«ç›‘å¬ |

### æ”¯æŒçš„é“¾æ¥æ ¼å¼

- âœ… `https://example.com/image.jpg`
- âœ… `https://example.com/image.jpg?v=123`
- âœ… `/uploads/default/original/4X/test.jpg`
- âœ… `https://linux.do/uploads/...`
- âœ… `.png`, `.jpg`, `.gif`, `.webp`, `.bmp`

---

## ğŸ“š æ–‡æ¡£æ›´æ–°

### æ–°å¢æ–‡æ¡£

1. **[Bugä¿®å¤è¯´æ˜.md](Bugä¿®å¤è¯´æ˜.md)**
   - è¯¦ç»†çš„é—®é¢˜åˆ†æ
   - ä¿®å¤æ–¹æ¡ˆè¯´æ˜
   - ä»£ç å¯¹æ¯”

2. **[æµ‹è¯•æŒ‡å—.md](æµ‹è¯•æŒ‡å—.md)**
   - 5 ä¸ªæµ‹è¯•é¡¹ç›®
   - è¯¦ç»†çš„æµ‹è¯•æ­¥éª¤
   - é¢„æœŸç»“æœè¯´æ˜

### æ›´æ–°æ–‡æ¡£

1. **README.md** - æ›´æ–°ç‰ˆæœ¬å†å²
2. **æ–‡æ¡£ç´¢å¼•.md** - æ·»åŠ æ–°æ–‡æ¡£é“¾æ¥

---

## ğŸš€ ä½¿ç”¨è¯´æ˜

### æ›´æ–°è„šæœ¬

1. æ‰“å¼€ Tampermonkey
2. æ‰¾åˆ° "Discourse è¡¨æƒ…æ‰©å±•"
3. ç‚¹å‡»ç¼–è¾‘
4. å…¨é€‰å¹¶æ›¿æ¢ä¸ºæ–°çš„ `a.js` å†…å®¹
5. ä¿å­˜ï¼ˆCtrl+Sï¼‰

### æµ‹è¯•åŠŸèƒ½

**æ–¹æ³• 1ï¼šå¿«é€Ÿæµ‹è¯•**
```
1. è®¿é—® Discourse è®ºå›
2. å¤åˆ¶å›¾ç‰‡é“¾æ¥
3. åœ¨ç¼–è¾‘å™¨ä¸­ç²˜è´´
4. è§‚å¯Ÿæ˜¯å¦è½¬æ¢ä¸º Markdown
```

**æ–¹æ³• 2ï¼šå®Œæ•´æµ‹è¯•**
æŸ¥çœ‹ **[æµ‹è¯•æŒ‡å—.md](æµ‹è¯•æŒ‡å—.md)** è¿›è¡Œå®Œæ•´æµ‹è¯•ã€‚

---

## ğŸ” è°ƒè¯•æç¤º

### æŸ¥çœ‹æ—¥å¿—

æ‰“å¼€æ§åˆ¶å°ï¼ˆF12ï¼‰ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```javascript
// åˆå§‹åŒ–
[Emoji Extension] Click handler attached to textarea
[Emoji Extension] Paste handler attached to textarea
[Emoji Extension] Paste handler attached to container

// ç²˜è´´æ—¶
[Emoji Extension] Paste event detected, items count: 1
[Emoji Extension] Image URL detected: https://...
[Emoji Extension] Image link inserted successfully
```

### æ£€æŸ¥ç»‘å®š

åœ¨æ§åˆ¶å°è¾“å…¥ï¼š
```javascript
document.querySelector('textarea.chat-composer__input')?.dataset
```

åº”è¯¥æ˜¾ç¤ºï¼š
```javascript
{
  emojiExtensionClickHandler: "true",
  emojiExtensionPasteHandler: "true",
  ...
}
```

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

æ›´æ–°åè¯·ç¡®è®¤ï¼š

- [ ] è„šæœ¬å·²æ›¿æ¢ä¸ºæœ€æ–°ç‰ˆæœ¬
- [ ] åˆ·æ–°äº† Discourse é¡µé¢
- [ ] æ§åˆ¶å°æ²¡æœ‰é”™è¯¯
- [ ] ç‚¹å‡» textarea ä¸ä¼šé‡å¤åˆ›å»ºæŒ‰é’®
- [ ] å¯ä»¥ç²˜è´´å›¾ç‰‡é“¾æ¥
- [ ] å¯ä»¥ç²˜è´´å›¾ç‰‡æ–‡ä»¶
- [ ] é˜…è¯»äº†æµ‹è¯•æŒ‡å—

**å…¨éƒ¨å®Œæˆï¼Ÿå¤ªæ£’äº†ï¼** ğŸŠ

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. ğŸ“– æŸ¥çœ‹ [æµ‹è¯•æŒ‡å—.md](æµ‹è¯•æŒ‡å—.md)
2. ğŸ“– æŸ¥çœ‹ [Bugä¿®å¤è¯´æ˜.md](Bugä¿®å¤è¯´æ˜.md)
3. ğŸ” æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—
4. ğŸ”„ å°è¯•åˆ·æ–°é¡µé¢
5. ğŸ”„ å°è¯•ç¦ç”¨å¹¶é‡æ–°å¯ç”¨è„šæœ¬

---

## ğŸ¯ ä¸‹ä¸€æ­¥

å»ºè®®é˜…è¯»ï¼š

1. **[æµ‹è¯•æŒ‡å—.md](æµ‹è¯•æŒ‡å—.md)** - å®Œæ•´æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
2. **[Bugä¿®å¤è¯´æ˜.md](Bugä¿®å¤è¯´æ˜.md)** - äº†è§£ä¿®å¤è¯¦æƒ…
3. **[å¿«é€Ÿä½¿ç”¨æŒ‡å—.md](å¿«é€Ÿä½¿ç”¨æŒ‡å—.md)** - å­¦ä¹ ä½¿ç”¨æŠ€å·§

---

<div align="center">

**ç‰ˆæœ¬ï¼š** v1.1.8  
**çŠ¶æ€ï¼š** âœ… ç¨³å®šå¯ç”¨  
**ä¿®å¤æ—¥æœŸï¼š** 2025å¹´1æœˆ

---

**ğŸ‰ Bug å·²ä¿®å¤ï¼ŒåŠŸèƒ½æ­£å¸¸ï¼**

æ„Ÿè°¢ä½¿ç”¨ Discourse è¡¨æƒ…æ‰©å±•ï¼

</div>
