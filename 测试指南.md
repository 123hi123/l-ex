# ✅ 快速测试指南

## 🎯 测试前准备

1. ✅ 确保已安装更新后的脚本
2. ✅ 刷新 Discourse 页面
3. ✅ 打开浏览器控制台（F12）观察日志

---

## 🧪 测试项目

### 测试 1️⃣：按钮不重复创建

**操作步骤：**
```
1. 打开 Discourse 聊天或回复编辑器
2. 点击 textarea 输入框
3. 移开鼠标，再次点击 textarea
4. 重复点击 3-5 次
```

**预期结果：**
- ✅ 工具栏只有 3 个扩展按钮：🐈‍⬛ ⭐ ⎘
- ✅ 按钮不会重复出现
- ✅ 每次点击后按钮位置不变

**失败表现：**
- ❌ 每次点击出现新的按钮组
- ❌ 工具栏有多个相同的按钮

**控制台日志：**
```
[Emoji Extension] Textarea clicked, refreshing extension buttons...
[Emoji Extension Userscript] Toolbar found, injecting button.  (只在需要时出现)
```

---

### 测试 2️⃣：粘贴完整图片 URL

**操作步骤：**
```
1. 复制以下链接：
   https://linux.do/uploads/default/original/4X/f/4/7/f479dbd309305ab14c53fd377cd51e44ee6f455e.webp

2. 在 textarea 中点击，确保光标在输入框内

3. 按 Ctrl+V (Windows) 或 Cmd+V (Mac) 粘贴
```

**预期结果：**
- ✅ 自动插入：`![image](https://linux.do/uploads/default/original/4X/f/4/7/f479dbd309305ab14c53fd377cd51e44ee6f455e.webp)`
- ✅ 光标移动到插入内容后
- ✅ 如果前后有文字，自动添加换行

**失败表现：**
- ❌ 粘贴后只显示原始链接文本
- ❌ 没有转换为 Markdown 格式

**控制台日志：**
```
[Emoji Extension] Paste event detected, items count: 1
[Emoji Extension] Image URL detected: https://...
[Emoji Extension] Image link inserted successfully
```

---

### 测试 3️⃣：粘贴相对路径

**操作步骤：**
```
1. 复制以下相对路径：
   /uploads/default/original/4X/test.jpg

2. 在 textarea 中粘贴
```

**预期结果：**
- ✅ 自动补全为：`![image](https://当前域名/uploads/default/original/4X/test.jpg)`
- ✅ 域名自动从 `window.location.origin` 获取

**控制台日志：**
```
[Emoji Extension] Image URL detected: /uploads/default/original/4X/test.jpg
[Emoji Extension] Image link inserted successfully
```

---

### 测试 4️⃣：粘贴图片文件

**操作步骤：**
```
1. 使用任意方式复制一张图片：
   - 截图工具 (Win+Shift+S)
   - 从文件管理器复制图片文件
   - 浏览器中右键图片 → 复制图像

2. 在 textarea 中粘贴
```

**预期结果：**
- ✅ 显示上传提示（控制台）
- ✅ 等待 1-2 秒上传完成
- ✅ 自动插入上传后的图片链接

**失败表现：**
- ❌ 没有任何反应
- ❌ 只粘贴了图片本身（不是链接）

**控制台日志：**
```
[Emoji Extension] Paste event detected, items count: 1
[Emoji Extension] Image file detected, uploading...
[Emoji Extension] Image uploaded and inserted: https://...
```

---

### 测试 5️⃣：外层容器粘贴

**操作步骤：**
```
1. 复制图片链接
2. 点击输入框外层容器（.chat-composer__input-container）
3. 粘贴
```

**预期结果：**
- ✅ 仍然能正确插入到 textarea 中
- ✅ 功能与直接在 textarea 中粘贴一致

**控制台日志：**
```
[Emoji Extension] Paste handler attached to container
[Emoji Extension] Paste event detected, items count: 1
[Emoji Extension] Image link inserted successfully
```

---

## 📊 测试检查清单

完成测试后，确认以下项目：

- [ ] 按钮不会重复创建（测试 1）
- [ ] 可以粘贴完整图片 URL（测试 2）
- [ ] 可以粘贴相对路径（测试 3）
- [ ] 可以粘贴图片文件并上传（测试 4）
- [ ] 外层容器粘贴也能工作（测试 5）
- [ ] 控制台没有错误信息
- [ ] 插入的内容格式正确

**全部勾选？恭喜！脚本工作正常！** 🎉

---

## 🐛 如果测试失败

### 检查步骤：

1. **确认脚本已更新**
   - 在 Tampermonkey 中查看脚本版本
   - 确认包含最新的修复代码

2. **查看控制台日志**
   - 打开 F12 控制台
   - 查看是否有错误信息
   - 检查是否有预期的日志输出

3. **刷新页面**
   - 按 Ctrl+Shift+R (Windows) 或 Cmd+Shift+R (Mac) 强制刷新
   - 清除缓存后重试

4. **检查环境**
   - 确认在正确的 Discourse 论坛
   - 确认 Tampermonkey 已启用
   - 确认脚本针对当前域名已启用

---

## 🔍 调试技巧

### 查看绑定状态

在控制台输入：
```javascript
// 检查 textarea 是否已绑定
document.querySelectorAll('textarea.chat-composer__input').forEach(ta => {
    console.log('Click handler:', ta.dataset.emojiExtensionClickHandler);
    console.log('Paste handler:', ta.dataset.emojiExtensionPasteHandler);
});
```

**应该显示：**
```
Click handler: true
Paste handler: true
```

### 手动测试粘贴

在控制台输入：
```javascript
// 手动插入图片链接
const textarea = document.querySelector('textarea.chat-composer__input');
if (textarea) {
    const event = new ClipboardEvent('paste', {
        clipboardData: new DataTransfer()
    });
    // 模拟粘贴事件
    textarea.dispatchEvent(event);
}
```

---

## 📝 报告问题

如果测试失败，请提供：

1. **失败的测试项目**（测试 1-5 中的哪一个）
2. **控制台错误信息**（完整的错误堆栈）
3. **浏览器和版本**（如：Chrome 120）
4. **Discourse 论坛地址**（如：linux.do）
5. **复现步骤**（详细操作步骤）

---

<div align="center">

**准备好了吗？开始测试！** 🚀

测试通过后，请查看 [Bug修复说明.md](Bug修复说明.md) 了解修复详情。

</div>
