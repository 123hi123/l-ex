# 🔧 聊天页面图片粘贴修复说明

## 📍 针对页面

**URL 路径：** `/chat/c/*`  
**示例：** `https://linux.do/chat/c/-/75`

---

## 🎯 新增功能

### 聊天页面专用插入逻辑

现在脚本会自动检测当前是否在聊天页面，并使用不同的插入策略。

```javascript
// 检测聊天页面
const isChatPage = window.location.pathname.includes('/chat/c');

if (isChatPage) {
    // 使用聊天页面专用插入方法
    insertImageToChatComposer(textarea, imageUrl);
} else {
    // 使用普通 Markdown 插入
    insertImageAsMarkdown(textarea, imageUrl);
}
```

---

## 🔧 聊天页面插入策略

### 方法 1：直接操作 DOM

```javascript
// 1. 设置 textarea 值
textarea.value = newValue;

// 2. 设置光标位置
textarea.selectionStart = newCursorPos;
textarea.selectionEnd = newCursorPos;

// 3. 触发多种事件
- input (bubbles: true)
- change (bubbles: true)  
- keyup (bubbles: true)
- InputEvent ('insertText')
- compositionend (bubbles: true)
```

### 方法 2：Ember 组件更新

```javascript
// 查找并触发 Ember 组件事件
const emberView = textarea.closest('[id^="ember"]');
if (emberView) {
    emberView.dispatchEvent(new CustomEvent('ember-action', {
        bubbles: true,
        detail: { value: newValue }
    }));
}
```

### 方法 3：原生 Setter 触发

```javascript
// 使用原生的 value setter
const nativeInputValueSetter = Object.getOwnPropertyDescriptor(
    window.HTMLTextAreaElement.prototype,
    'value'
).set;

nativeInputValueSetter.call(textarea, newValue);
textarea.dispatchEvent(new Event('input', { bubbles: true }));
```

---

## 📊 调试日志增强

现在粘贴时会输出详细的调试信息：

```javascript
// 基本信息
[Emoji Extension] Paste event detected
[Emoji Extension] Items count: 1
[Emoji Extension] Textarea: ember-text-area ember-view chat-composer__input
[Emoji Extension] Current page: /chat/c/-/75

// Item 信息
[Emoji Extension] Item 0: type="text/plain", kind="string"

// 内容检测
[Emoji Extension] Text content: https://linux.do/uploads/...
[Emoji Extension] ✅ Image URL detected, inserting: https://...

// 插入状态
[Emoji Extension] Inserting image, isChatPage: true, URL: https://...
[Emoji Extension] Inserting image to chat composer
[Emoji Extension] Chat composer image inserted
```

---

## 🧪 测试步骤

### 测试 1：粘贴图片链接

**步骤：**
```
1. 访问 https://linux.do/chat/c/-/75 (或任意聊天频道)
2. 复制一个图片链接，例如：
   https://linux.do/uploads/default/original/4X/f/4/7/f479dbd.webp
3. 点击聊天输入框
4. 按 Ctrl+V 粘贴
5. 打开控制台（F12）查看日志
```

**预期结果：**
- ✅ 控制台显示：`[Emoji Extension] ✅ Image URL detected, inserting:`
- ✅ 控制台显示：`[Emoji Extension] Inserting image, isChatPage: true`
- ✅ 控制台显示：`[Emoji Extension] Chat composer image inserted`
- ✅ 输入框中出现：`![image](https://...)`

---

### 测试 2：粘贴图片文件

**步骤：**
```
1. 在聊天页面
2. 使用截图工具截图（Win+Shift+S）
3. 在聊天输入框中粘贴（Ctrl+V）
4. 观察控制台
```

**预期结果：**
- ✅ 控制台显示：`[Emoji Extension] ✅ Image file detected, uploading...`
- ✅ 控制台显示：`[Emoji Extension] ✅ Upload successful, inserting:`
- ✅ 图片上传完成并插入链接

---

### 测试 3：对比非聊天页面

**步骤：**
```
1. 访问普通主题页面，如：
   https://linux.do/t/topic/123
2. 进入回复编辑器
3. 粘贴图片链接
4. 观察控制台
```

**预期结果：**
- ✅ 控制台显示：`[Emoji Extension] Inserting image, isChatPage: false`
- ✅ 使用普通 Markdown 插入（带换行符）

---

## 🔍 调试技巧

### 1. 检查粘贴事件是否触发

在控制台输入：
```javascript
document.querySelector('textarea.chat-composer__input')?.addEventListener('paste', (e) => {
    console.log('PASTE EVENT:', e);
    console.log('Clipboard items:', e.clipboardData?.items);
});
```

### 2. 手动测试插入

在控制台输入：
```javascript
const textarea = document.querySelector('textarea.chat-composer__input');
if (textarea) {
    const imageUrl = 'https://linux.do/uploads/default/original/4X/test.jpg';
    textarea.value = textarea.value + `![image](${imageUrl})`;
    textarea.dispatchEvent(new Event('input', { bubbles: true }));
    console.log('Manual insert done');
}
```

### 3. 检查 Ember 组件

在控制台输入：
```javascript
const textarea = document.querySelector('textarea.chat-composer__input');
const emberView = textarea?.closest('[id^="ember"]');
console.log('Ember view:', emberView);
console.log('Ember ID:', emberView?.id);
```

---

## ⚠️ 常见问题

### Q1: 粘贴后没有插入图片链接？

**检查：**
1. 打开控制台查看是否有日志输出
2. 确认是否显示 `[Emoji Extension] Paste event detected`
3. 检查是否显示 `isChatPage: true`

**解决：**
- 如果没有任何日志，说明粘贴事件没有被监听
- 检查脚本是否已启用
- 刷新页面重试

---

### Q2: 日志显示插入成功但 textarea 没有变化？

**检查：**
1. 查看 `textarea.value` 是否已更新
2. 检查事件是否被正确触发

**解决：**
在控制台手动检查：
```javascript
const textarea = document.querySelector('textarea.chat-composer__input');
console.log('Current value:', textarea.value);
console.log('Has handlers:', textarea.dataset);
```

---

### Q3: 图片链接没有被识别？

**检查：**
1. 查看控制台日志中的 `Text content:`
2. 确认链接格式是否正确

**支持的格式：**
- ✅ `https://example.com/image.jpg`
- ✅ `https://example.com/image.jpg?v=123`
- ✅ `/uploads/default/original/4X/test.jpg`
- ✅ 任何包含 `/uploads/` 的路径

---

## 📝 技术细节

### 页面检测

```javascript
const isChatPage = window.location.pathname.includes('/chat/c');
```

匹配的路径：
- `/chat/c/-/75`
- `/chat/c/general/123`
- 任何以 `/chat/c` 开头的路径

### 事件触发顺序

```
1. input (InputEvent, insertText)
2. input (Event, bubbles)
3. change (Event, bubbles)
4. keyup (KeyboardEvent, bubbles)
5. compositionend (Event, bubbles)
6. [延迟 10ms]
7. 使用 native setter 再次触发 input
```

---

## ✅ 检查清单

测试完成后确认：

- [ ] 在聊天页面能粘贴图片链接
- [ ] 控制台显示 `isChatPage: true`
- [ ] 图片链接正确插入到 textarea
- [ ] 在普通页面粘贴仍然正常工作
- [ ] 控制台没有错误信息

---

## 📞 如果仍然不工作

请提供以下信息：

1. **控制台完整日志**（从 `[Emoji Extension] Paste event detected` 开始）
2. **粘贴的内容**（图片链接或文件类型）
3. **当前页面 URL**
4. **Textarea 的 className**（从日志中复制）
5. **是否有任何错误信息**

---

<div align="center">

**版本：** v1.1.9  
**修复内容：** 聊天页面图片粘贴功能  
**状态：** ✅ 待测试

---

请按照上述步骤测试，并查看控制台日志！🔍

</div>
