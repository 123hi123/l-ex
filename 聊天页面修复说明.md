# ğŸ”§ èŠå¤©é¡µé¢å›¾ç‰‡ç²˜è´´ä¿®å¤è¯´æ˜

## ğŸ“ é’ˆå¯¹é¡µé¢

**URL è·¯å¾„ï¼š** `/chat/c/*`  
**ç¤ºä¾‹ï¼š** `https://linux.do/chat/c/-/75`

---

## ğŸ¯ æ–°å¢åŠŸèƒ½

### èŠå¤©é¡µé¢ä¸“ç”¨æ’å…¥é€»è¾‘

ç°åœ¨è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹å½“å‰æ˜¯å¦åœ¨èŠå¤©é¡µé¢ï¼Œå¹¶ä½¿ç”¨ä¸åŒçš„æ’å…¥ç­–ç•¥ã€‚

```javascript
// æ£€æµ‹èŠå¤©é¡µé¢
const isChatPage = window.location.pathname.includes('/chat/c');

if (isChatPage) {
    // ä½¿ç”¨èŠå¤©é¡µé¢ä¸“ç”¨æ’å…¥æ–¹æ³•
    insertImageToChatComposer(textarea, imageUrl);
} else {
    // ä½¿ç”¨æ™®é€š Markdown æ’å…¥
    insertImageAsMarkdown(textarea, imageUrl);
}
```

---

## ğŸ”§ èŠå¤©é¡µé¢æ’å…¥ç­–ç•¥

### æ–¹æ³• 1ï¼šç›´æ¥æ“ä½œ DOM

```javascript
// 1. è®¾ç½® textarea å€¼
textarea.value = newValue;

// 2. è®¾ç½®å…‰æ ‡ä½ç½®
textarea.selectionStart = newCursorPos;
textarea.selectionEnd = newCursorPos;

// 3. è§¦å‘å¤šç§äº‹ä»¶
- input (bubbles: true)
- change (bubbles: true)  
- keyup (bubbles: true)
- InputEvent ('insertText')
- compositionend (bubbles: true)
```

### æ–¹æ³• 2ï¼šEmber ç»„ä»¶æ›´æ–°

```javascript
// æŸ¥æ‰¾å¹¶è§¦å‘ Ember ç»„ä»¶äº‹ä»¶
const emberView = textarea.closest('[id^="ember"]');
if (emberView) {
    emberView.dispatchEvent(new CustomEvent('ember-action', {
        bubbles: true,
        detail: { value: newValue }
    }));
}
```

### æ–¹æ³• 3ï¼šåŸç”Ÿ Setter è§¦å‘

```javascript
// ä½¿ç”¨åŸç”Ÿçš„ value setter
const nativeInputValueSetter = Object.getOwnPropertyDescriptor(
    window.HTMLTextAreaElement.prototype,
    'value'
).set;

nativeInputValueSetter.call(textarea, newValue);
textarea.dispatchEvent(new Event('input', { bubbles: true }));
```

---

## ğŸ“Š è°ƒè¯•æ—¥å¿—å¢å¼º

ç°åœ¨ç²˜è´´æ—¶ä¼šè¾“å‡ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼š

```javascript
// åŸºæœ¬ä¿¡æ¯
[Emoji Extension] Paste event detected
[Emoji Extension] Items count: 1
[Emoji Extension] Textarea: ember-text-area ember-view chat-composer__input
[Emoji Extension] Current page: /chat/c/-/75

// Item ä¿¡æ¯
[Emoji Extension] Item 0: type="text/plain", kind="string"

// å†…å®¹æ£€æµ‹
[Emoji Extension] Text content: https://linux.do/uploads/...
[Emoji Extension] âœ… Image URL detected, inserting: https://...

// æ’å…¥çŠ¶æ€
[Emoji Extension] Inserting image, isChatPage: true, URL: https://...
[Emoji Extension] Inserting image to chat composer
[Emoji Extension] Chat composer image inserted
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯• 1ï¼šç²˜è´´å›¾ç‰‡é“¾æ¥

**æ­¥éª¤ï¼š**
```
1. è®¿é—® https://linux.do/chat/c/-/75 (æˆ–ä»»æ„èŠå¤©é¢‘é“)
2. å¤åˆ¶ä¸€ä¸ªå›¾ç‰‡é“¾æ¥ï¼Œä¾‹å¦‚ï¼š
   https://linux.do/uploads/default/original/4X/f/4/7/f479dbd.webp
3. ç‚¹å‡»èŠå¤©è¾“å…¥æ¡†
4. æŒ‰ Ctrl+V ç²˜è´´
5. æ‰“å¼€æ§åˆ¶å°ï¼ˆF12ï¼‰æŸ¥çœ‹æ—¥å¿—
```

**é¢„æœŸç»“æœï¼š**
- âœ… æ§åˆ¶å°æ˜¾ç¤ºï¼š`[Emoji Extension] âœ… Image URL detected, inserting:`
- âœ… æ§åˆ¶å°æ˜¾ç¤ºï¼š`[Emoji Extension] Inserting image, isChatPage: true`
- âœ… æ§åˆ¶å°æ˜¾ç¤ºï¼š`[Emoji Extension] Chat composer image inserted`
- âœ… è¾“å…¥æ¡†ä¸­å‡ºç°ï¼š`![image](https://...)`

---

### æµ‹è¯• 2ï¼šç²˜è´´å›¾ç‰‡æ–‡ä»¶

**æ­¥éª¤ï¼š**
```
1. åœ¨èŠå¤©é¡µé¢
2. ä½¿ç”¨æˆªå›¾å·¥å…·æˆªå›¾ï¼ˆWin+Shift+Sï¼‰
3. åœ¨èŠå¤©è¾“å…¥æ¡†ä¸­ç²˜è´´ï¼ˆCtrl+Vï¼‰
4. è§‚å¯Ÿæ§åˆ¶å°
```

**é¢„æœŸç»“æœï¼š**
- âœ… æ§åˆ¶å°æ˜¾ç¤ºï¼š`[Emoji Extension] âœ… Image file detected, uploading...`
- âœ… æ§åˆ¶å°æ˜¾ç¤ºï¼š`[Emoji Extension] âœ… Upload successful, inserting:`
- âœ… å›¾ç‰‡ä¸Šä¼ å®Œæˆå¹¶æ’å…¥é“¾æ¥

---

### æµ‹è¯• 3ï¼šå¯¹æ¯”éèŠå¤©é¡µé¢

**æ­¥éª¤ï¼š**
```
1. è®¿é—®æ™®é€šä¸»é¢˜é¡µé¢ï¼Œå¦‚ï¼š
   https://linux.do/t/topic/123
2. è¿›å…¥å›å¤ç¼–è¾‘å™¨
3. ç²˜è´´å›¾ç‰‡é“¾æ¥
4. è§‚å¯Ÿæ§åˆ¶å°
```

**é¢„æœŸç»“æœï¼š**
- âœ… æ§åˆ¶å°æ˜¾ç¤ºï¼š`[Emoji Extension] Inserting image, isChatPage: false`
- âœ… ä½¿ç”¨æ™®é€š Markdown æ’å…¥ï¼ˆå¸¦æ¢è¡Œç¬¦ï¼‰

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æ£€æŸ¥ç²˜è´´äº‹ä»¶æ˜¯å¦è§¦å‘

åœ¨æ§åˆ¶å°è¾“å…¥ï¼š
```javascript
document.querySelector('textarea.chat-composer__input')?.addEventListener('paste', (e) => {
    console.log('PASTE EVENT:', e);
    console.log('Clipboard items:', e.clipboardData?.items);
});
```

### 2. æ‰‹åŠ¨æµ‹è¯•æ’å…¥

åœ¨æ§åˆ¶å°è¾“å…¥ï¼š
```javascript
const textarea = document.querySelector('textarea.chat-composer__input');
if (textarea) {
    const imageUrl = 'https://linux.do/uploads/default/original/4X/test.jpg';
    textarea.value = textarea.value + `![image](${imageUrl})`;
    textarea.dispatchEvent(new Event('input', { bubbles: true }));
    console.log('Manual insert done');
}
```

### 3. æ£€æŸ¥ Ember ç»„ä»¶

åœ¨æ§åˆ¶å°è¾“å…¥ï¼š
```javascript
const textarea = document.querySelector('textarea.chat-composer__input');
const emberView = textarea?.closest('[id^="ember"]');
console.log('Ember view:', emberView);
console.log('Ember ID:', emberView?.id);
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ç²˜è´´åæ²¡æœ‰æ’å…¥å›¾ç‰‡é“¾æ¥ï¼Ÿ

**æ£€æŸ¥ï¼š**
1. æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹æ˜¯å¦æœ‰æ—¥å¿—è¾“å‡º
2. ç¡®è®¤æ˜¯å¦æ˜¾ç¤º `[Emoji Extension] Paste event detected`
3. æ£€æŸ¥æ˜¯å¦æ˜¾ç¤º `isChatPage: true`

**è§£å†³ï¼š**
- å¦‚æœæ²¡æœ‰ä»»ä½•æ—¥å¿—ï¼Œè¯´æ˜ç²˜è´´äº‹ä»¶æ²¡æœ‰è¢«ç›‘å¬
- æ£€æŸ¥è„šæœ¬æ˜¯å¦å·²å¯ç”¨
- åˆ·æ–°é¡µé¢é‡è¯•

---

### Q2: æ—¥å¿—æ˜¾ç¤ºæ’å…¥æˆåŠŸä½† textarea æ²¡æœ‰å˜åŒ–ï¼Ÿ

**æ£€æŸ¥ï¼š**
1. æŸ¥çœ‹ `textarea.value` æ˜¯å¦å·²æ›´æ–°
2. æ£€æŸ¥äº‹ä»¶æ˜¯å¦è¢«æ­£ç¡®è§¦å‘

**è§£å†³ï¼š**
åœ¨æ§åˆ¶å°æ‰‹åŠ¨æ£€æŸ¥ï¼š
```javascript
const textarea = document.querySelector('textarea.chat-composer__input');
console.log('Current value:', textarea.value);
console.log('Has handlers:', textarea.dataset);
```

---

### Q3: å›¾ç‰‡é“¾æ¥æ²¡æœ‰è¢«è¯†åˆ«ï¼Ÿ

**æ£€æŸ¥ï¼š**
1. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ä¸­çš„ `Text content:`
2. ç¡®è®¤é“¾æ¥æ ¼å¼æ˜¯å¦æ­£ç¡®

**æ”¯æŒçš„æ ¼å¼ï¼š**
- âœ… `https://example.com/image.jpg`
- âœ… `https://example.com/image.jpg?v=123`
- âœ… `/uploads/default/original/4X/test.jpg`
- âœ… ä»»ä½•åŒ…å« `/uploads/` çš„è·¯å¾„

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### é¡µé¢æ£€æµ‹

```javascript
const isChatPage = window.location.pathname.includes('/chat/c');
```

åŒ¹é…çš„è·¯å¾„ï¼š
- `/chat/c/-/75`
- `/chat/c/general/123`
- ä»»ä½•ä»¥ `/chat/c` å¼€å¤´çš„è·¯å¾„

### äº‹ä»¶è§¦å‘é¡ºåº

```
1. input (InputEvent, insertText)
2. input (Event, bubbles)
3. change (Event, bubbles)
4. keyup (KeyboardEvent, bubbles)
5. compositionend (Event, bubbles)
6. [å»¶è¿Ÿ 10ms]
7. ä½¿ç”¨ native setter å†æ¬¡è§¦å‘ input
```

---

## âœ… æ£€æŸ¥æ¸…å•

æµ‹è¯•å®Œæˆåç¡®è®¤ï¼š

- [ ] åœ¨èŠå¤©é¡µé¢èƒ½ç²˜è´´å›¾ç‰‡é“¾æ¥
- [ ] æ§åˆ¶å°æ˜¾ç¤º `isChatPage: true`
- [ ] å›¾ç‰‡é“¾æ¥æ­£ç¡®æ’å…¥åˆ° textarea
- [ ] åœ¨æ™®é€šé¡µé¢ç²˜è´´ä»ç„¶æ­£å¸¸å·¥ä½œ
- [ ] æ§åˆ¶å°æ²¡æœ‰é”™è¯¯ä¿¡æ¯

---

## ğŸ“ å¦‚æœä»ç„¶ä¸å·¥ä½œ

è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **æ§åˆ¶å°å®Œæ•´æ—¥å¿—**ï¼ˆä» `[Emoji Extension] Paste event detected` å¼€å§‹ï¼‰
2. **ç²˜è´´çš„å†…å®¹**ï¼ˆå›¾ç‰‡é“¾æ¥æˆ–æ–‡ä»¶ç±»å‹ï¼‰
3. **å½“å‰é¡µé¢ URL**
4. **Textarea çš„ className**ï¼ˆä»æ—¥å¿—ä¸­å¤åˆ¶ï¼‰
5. **æ˜¯å¦æœ‰ä»»ä½•é”™è¯¯ä¿¡æ¯**

---

<div align="center">

**ç‰ˆæœ¬ï¼š** v1.1.9  
**ä¿®å¤å†…å®¹ï¼š** èŠå¤©é¡µé¢å›¾ç‰‡ç²˜è´´åŠŸèƒ½  
**çŠ¶æ€ï¼š** âœ… å¾…æµ‹è¯•

---

è¯·æŒ‰ç…§ä¸Šè¿°æ­¥éª¤æµ‹è¯•ï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼ğŸ”

</div>
