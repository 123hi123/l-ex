<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discourse 表情扩展 - 功能测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 30px;
            padding: 10px;
            background: #f0f0f0;
            border-left: 4px solid #4CAF50;
        }
        .feature {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            margin: 15px 0;
        }
        .feature h3 {
            color: #4CAF50;
            margin-top: 0;
        }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
        }
        .demo-textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        .demo-textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
        }
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
        }
        .success-box {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin: 15px 0;
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .button:hover {
            background: #45a049;
        }
        ul {
            line-height: 1.8;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎉 Discourse 表情扩展 - 新功能测试页面</h1>
        
        <div class="success-box">
            <strong>✅ 更新成功！</strong> 您的脚本已经添加了以下新功能：
        </div>

        <h2>📌 功能 1：Textarea 点击自动刷新</h2>
        <div class="feature">
            <h3>功能说明</h3>
            <p>当您点击 Discourse 编辑器的 textarea 时，三个扩展按钮会自动刷新：</p>
            <ul>
                <li>🐈‍⬛ 表情包按钮</li>
                <li>⭐ 常用表情按钮</li>
                <li>⎘ 快捷输入按钮</li>
            </ul>

            <h3>使用方法</h3>
            <div class="info-box">
                <strong>步骤：</strong>
                <ol>
                    <li>在 Discourse 论坛打开任何可以输入的地方</li>
                    <li>点击 textarea 输入框</li>
                    <li>观察工具栏上的扩展按钮会自动刷新</li>
                </ol>
            </div>

            <h3>技术实现</h3>
            <div class="code-block">
// 为 textarea 添加点击事件监听器
function setupTextareaClickHandlers() {
    const textareas = document.querySelectorAll(
        'textarea.chat-composer__input, ' +
        'textarea[data-chat-composer-context="channel"]'
    );
    
    textareas.forEach((textarea) => {
        textarea.addEventListener('click', () => {
            // 刷新扩展按钮
            refreshExtensionButtons();
        });
    });
}
            </div>
        </div>

        <h2>🖼️ 功能 2：改进的图片粘贴功能</h2>
        <div class="feature">
            <h3>功能说明</h3>
            <p>支持直接粘贴图片文件，自动上传并插入图片链接到编辑器中。</p>

            <h3>使用方法</h3>
            <div class="info-box">
                <strong>步骤：</strong>
                <ol>
                    <li>在任何应用中复制一张图片（例如：截图、从文件管理器复制等）</li>
                    <li>在 Discourse 编辑器中按 <code>Ctrl+V</code>（Windows）或 <code>Cmd+V</code>（Mac）粘贴</li>
                    <li>脚本会自动上传图片到服务器</li>
                    <li>上传完成后，图片链接会自动插入到光标位置</li>
                </ol>
            </div>

            <h3>模拟演示</h3>
            <p>在下方 textarea 中粘贴图片试试看（这只是演示，实际功能需要在 Discourse 论坛使用）：</p>
            <textarea 
                class="demo-textarea" 
                placeholder="在这里粘贴图片...（实际功能需要在 Discourse 论坛中使用）"
                id="demoTextarea"
            ></textarea>
            <div id="pasteResult" style="margin-top: 10px;"></div>

            <h3>插入格式</h3>
            <div class="code-block">
// 插入的 Markdown 格式
![image](https://example.com/uploads/image.jpg)

// 示例
![image](https://linux.do/uploads/default/original/4X/f/4/7/f479dbd.webp)
            </div>

            <h3>支持的编辑器</h3>
            <ul>
                <li>✅ Discourse 主题回复编辑器</li>
                <li>✅ Chat 聊天编辑器</li>
                <li>✅ 私信编辑器</li>
                <li>✅ 所有带有 <code>d-editor-input</code> 或 <code>chat-composer__input</code> 类的编辑器</li>
            </ul>
        </div>

        <h2>🔧 技术细节</h2>
        <div class="feature">
            <h3>自动初始化时机</h3>
            <ul>
                <li>页面加载完成时</li>
                <li>检测到新的编辑器工具栏时</li>
                <li>网络请求（drafts/posts/t/）完成后</li>
                <li>手动刷新按钮时</li>
            </ul>

            <h3>防止重复绑定</h3>
            <p>脚本使用 dataset 标记来防止重复绑定事件：</p>
            <div class="code-block">
textarea.dataset.emojiExtensionClickHandler = 'true';
textarea.dataset.emojiExtensionPasteHandler = 'true';
            </div>

            <h3>图片上传 API</h3>
            <div class="code-block">
POST /uploads.json
Headers:
  X-CSRF-Token: [从 meta 标签获取]
FormData:
  file: [图片文件]
  type: 'composer'
  synchronous: 'true'
            </div>
        </div>

        <h2>⚠️ 注意事项</h2>
        <div class="warning-box">
            <strong>重要提示：</strong>
            <ul>
                <li>图片粘贴功能仅在 Discourse 论坛中有效</li>
                <li>需要正确的 CSRF Token 才能上传图片</li>
                <li>上传的图片大小受服务器限制</li>
                <li>部分浏览器可能需要授予粘贴板权限</li>
            </ul>
        </div>

        <h2>📝 更新日志</h2>
        <div class="feature">
            <h3>版本 1.1.7</h3>
            <ul>
                <li>✨ 新增：Textarea 点击自动刷新扩展按钮</li>
                <li>✨ 新增：改进的图片粘贴功能，支持自动上传并插入链接</li>
                <li>🔧 优化：添加了更多的事件监听器绑定检查</li>
                <li>🐛 修复：防止重复绑定事件处理器</li>
                <li>📚 文档：添加了详细的功能说明和使用文档</li>
            </ul>
        </div>

        <h2>🎯 下一步计划</h2>
        <div class="info-box">
            <strong>后续优化方向：</strong>
            <ul>
                <li>添加图片上传进度提示</li>
                <li>支持多图片批量粘贴</li>
                <li>添加上传失败重试机制</li>
                <li>支持自定义图片插入格式</li>
                <li>添加图片压缩选项</li>
            </ul>
        </div>

        <div class="success-box" style="margin-top: 30px;">
            <strong>🎊 完成！</strong> 您的脚本现在已经具备这些新功能。请在 Discourse 论坛中测试使用。
        </div>
    </div>

    <script>
        // 演示粘贴检测（仅用于演示）
        const demoTextarea = document.getElementById('demoTextarea');
        const pasteResult = document.getElementById('pasteResult');

        demoTextarea.addEventListener('paste', (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf('image') !== -1) {
                    pasteResult.innerHTML = `
                        <div class="success-box">
                            <strong>✅ 检测到图片粘贴！</strong><br>
                            类型: ${item.type}<br>
                            在实际的 Discourse 论坛中，这张图片会被自动上传并插入链接。
                        </div>
                    `;
                    return;
                }
            }
            
            pasteResult.innerHTML = `
                <div class="info-box">
                    <strong>ℹ️ 检测到文本粘贴</strong><br>
                    请粘贴图片文件来测试图片粘贴功能。
                </div>
            `;
        });
    </script>
</body>
</html>
