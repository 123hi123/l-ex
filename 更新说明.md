# Discourse è¡¨æƒ…æ‰©å±• - æ›´æ–°è¯´æ˜

## ç‰ˆæœ¬ 1.1.7 - æ–°å¢åŠŸèƒ½

### 1. Textarea ç‚¹å‡»è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½

å½“ç”¨æˆ·ç‚¹å‡» textarea å…ƒç´ ï¼ˆç‰¹åˆ«æ˜¯ `chat-composer__input` æˆ– `data-chat-composer-context="channel"`ï¼‰æ—¶ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨åˆ·æ–°ä¸‰ä¸ªæ‰©å±•æ’ä»¶æŒ‰é’®ï¼š
- ğŸˆâ€â¬› è¡¨æƒ…åŒ…æŒ‰é’®
- â­ å¸¸ç”¨è¡¨æƒ…æŒ‰é’®
- â˜ å¿«æ·è¾“å…¥æŒ‰é’®

**å®ç°ç»†èŠ‚ï¼š**
- æ·»åŠ äº† `setupTextareaClickHandlers()` å‡½æ•°
- ä½¿ç”¨ `data-emojiExtensionClickHandler` æ ‡è®°é˜²æ­¢é‡å¤ç»‘å®š
- ç‚¹å‡»æ—¶ä¼šç§»é™¤æ—§æŒ‰é’®å¹¶é‡æ–°æ³¨å…¥æ–°æŒ‰é’®

### 2. æ”¹è¿›çš„å›¾ç‰‡ç²˜è´´åŠŸèƒ½

æ”¯æŒé€šè¿‡ç²˜è´´å›¾ç‰‡æ–‡ä»¶è‡ªåŠ¨ä¸Šä¼ å¹¶æ’å…¥é“¾æ¥åˆ° textarea ä¸­ã€‚

**åŠŸèƒ½ç‰¹ç‚¹ï¼š**
- æ£€æµ‹å‰ªè´´æ¿ä¸­çš„å›¾ç‰‡æ–‡ä»¶
- è‡ªåŠ¨ä¸Šä¼ åˆ° Discourse æœåŠ¡å™¨
- ä»¥ Markdown æ ¼å¼æ’å…¥å›¾ç‰‡é“¾æ¥ï¼š`![image](url)`
- æ’å…¥ä½ç½®ï¼šå…‰æ ‡å½“å‰ä½ç½®æˆ–å†…å®¹æœ«å°¾
- æ”¯æŒæ‰€æœ‰ç¼–è¾‘å™¨ textareaï¼ˆåŒ…æ‹¬ chat-composer å’Œ d-editor-inputï¼‰

**å®ç°ç»†èŠ‚ï¼š**
- æ·»åŠ äº† `setupPasteHandlers()` å‡½æ•°ç›‘å¬ç²˜è´´äº‹ä»¶
- æ·»åŠ äº† `uploadImageToDiscourse()` å‡½æ•°å¤„ç†å›¾ç‰‡ä¸Šä¼ 
- æ·»åŠ äº† `insertImageLink()` å‡½æ•°æ’å…¥å›¾ç‰‡é“¾æ¥
- ä½¿ç”¨ Discourse çš„ `/uploads.json` API ä¸Šä¼ å›¾ç‰‡
- è‡ªåŠ¨å¤„ç† CSRF Token

### 3. è‡ªåŠ¨åˆå§‹åŒ–

è¿™äº›æ–°åŠŸèƒ½ä¼šåœ¨ä»¥ä¸‹æ—¶æœºè‡ªåŠ¨åˆå§‹åŒ–ï¼š
- é¡µé¢åŠ è½½å®Œæˆæ—¶
- æ£€æµ‹åˆ°æ–°çš„ç¼–è¾‘å™¨å·¥å…·æ æ—¶
- ç½‘ç»œè¯·æ±‚ï¼ˆdrafts/posts/t/ï¼‰å®Œæˆå
- æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®æ—¶

## ä½¿ç”¨è¯´æ˜

### Textarea ç‚¹å‡»åˆ·æ–°
åªéœ€ç‚¹å‡»ä»»ä½• Discourse ç¼–è¾‘å™¨çš„ textareaï¼Œæ‰©å±•æŒ‰é’®å°±ä¼šè‡ªåŠ¨åˆ·æ–°ã€‚

### å›¾ç‰‡ç²˜è´´
1. åœ¨ä»»ä½•æ”¯æŒçš„åº”ç”¨ä¸­å¤åˆ¶å›¾ç‰‡ï¼ˆå¦‚æˆªå›¾å·¥å…·ã€å›¾ç‰‡æŸ¥çœ‹å™¨ç­‰ï¼‰
2. åœ¨ Discourse ç¼–è¾‘å™¨çš„ textarea ä¸­ç²˜è´´ï¼ˆCtrl+V æˆ– Cmd+Vï¼‰
3. è„šæœ¬ä¼šè‡ªåŠ¨ä¸Šä¼ å›¾ç‰‡å¹¶æ’å…¥é“¾æ¥
4. å›¾ç‰‡é“¾æ¥ä¼šä»¥ Markdown æ ¼å¼æ’å…¥åˆ°å…‰æ ‡ä½ç½®

## æŠ€æœ¯ç»†èŠ‚

### æ”¯æŒçš„ Textarea é€‰æ‹©å™¨
```javascript
'textarea.chat-composer__input'
'textarea[data-chat-composer-context="channel"]'
'textarea.d-editor-input'
```

### é˜²æ­¢é‡å¤ç»‘å®š
ä½¿ç”¨ dataset æ ‡è®°ï¼š
- `data-emojiExtensionClickHandler`
- `data-emojiExtensionPasteHandler`

### å›¾ç‰‡ä¸Šä¼  API
```
POST /uploads.json
FormData:
  - file: [å›¾ç‰‡æ–‡ä»¶]
  - type: 'composer'
  - synchronous: 'true'
```

## æ³¨æ„äº‹é¡¹

1. å›¾ç‰‡ç²˜è´´åŠŸèƒ½éœ€è¦æ­£ç¡®çš„ CSRF Token
2. å›¾ç‰‡ä¸Šä¼ ä½¿ç”¨ Discourse çš„å®˜æ–¹ API
3. æ‰€æœ‰äº‹ä»¶å¤„ç†å™¨éƒ½æœ‰é”™è¯¯æ•è·å’Œæ—¥å¿—è¾“å‡º
4. æ”¯æŒåŠ¨æ€åŠ è½½çš„ç¼–è¾‘å™¨ï¼ˆé€šè¿‡ç½‘ç»œè¯·æ±‚ç›‘å¬ï¼‰

## å…¼å®¹æ€§

- âœ… Linux.do
- âœ… Meta Discourse
- âœ… å…¶ä»– Discourse è®ºå›
- âœ… Chrome/Edge (Tampermonkey)
- âœ… Firefox (Greasemonkey/Tampermonkey)
- âœ… Safari (Userscripts)

## åç»­ä¼˜åŒ–å»ºè®®

1. æ·»åŠ å›¾ç‰‡ä¸Šä¼ è¿›åº¦æç¤º
2. æ”¯æŒå¤šå›¾ç‰‡æ‰¹é‡ç²˜è´´
3. æ·»åŠ ä¸Šä¼ å¤±è´¥é‡è¯•æœºåˆ¶
4. æ”¯æŒè‡ªå®šä¹‰å›¾ç‰‡æ’å…¥æ ¼å¼
5. æ·»åŠ å›¾ç‰‡å‹ç¼©é€‰é¡¹
