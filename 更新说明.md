# Discourse 表情扩展 - 更新说明

## 版本 1.1.7 - 新增功能

### 1. Textarea 点击自动刷新功能

当用户点击 textarea 元素（特别是 `chat-composer__input` 或 `data-chat-composer-context="channel"`）时，脚本会自动刷新三个扩展插件按钮：
- 🐈‍⬛ 表情包按钮
- ⭐ 常用表情按钮
- ⎘ 快捷输入按钮

**实现细节：**
- 添加了 `setupTextareaClickHandlers()` 函数
- 使用 `data-emojiExtensionClickHandler` 标记防止重复绑定
- 点击时会移除旧按钮并重新注入新按钮

### 2. 改进的图片粘贴功能

支持通过粘贴图片文件自动上传并插入链接到 textarea 中。

**功能特点：**
- 检测剪贴板中的图片文件
- 自动上传到 Discourse 服务器
- 以 Markdown 格式插入图片链接：`![image](url)`
- 插入位置：光标当前位置或内容末尾
- 支持所有编辑器 textarea（包括 chat-composer 和 d-editor-input）

**实现细节：**
- 添加了 `setupPasteHandlers()` 函数监听粘贴事件
- 添加了 `uploadImageToDiscourse()` 函数处理图片上传
- 添加了 `insertImageLink()` 函数插入图片链接
- 使用 Discourse 的 `/uploads.json` API 上传图片
- 自动处理 CSRF Token

### 3. 自动初始化

这些新功能会在以下时机自动初始化：
- 页面加载完成时
- 检测到新的编辑器工具栏时
- 网络请求（drafts/posts/t/）完成后
- 手动刷新按钮时

## 使用说明

### Textarea 点击刷新
只需点击任何 Discourse 编辑器的 textarea，扩展按钮就会自动刷新。

### 图片粘贴
1. 在任何支持的应用中复制图片（如截图工具、图片查看器等）
2. 在 Discourse 编辑器的 textarea 中粘贴（Ctrl+V 或 Cmd+V）
3. 脚本会自动上传图片并插入链接
4. 图片链接会以 Markdown 格式插入到光标位置

## 技术细节

### 支持的 Textarea 选择器
```javascript
'textarea.chat-composer__input'
'textarea[data-chat-composer-context="channel"]'
'textarea.d-editor-input'
```

### 防止重复绑定
使用 dataset 标记：
- `data-emojiExtensionClickHandler`
- `data-emojiExtensionPasteHandler`

### 图片上传 API
```
POST /uploads.json
FormData:
  - file: [图片文件]
  - type: 'composer'
  - synchronous: 'true'
```

## 注意事项

1. 图片粘贴功能需要正确的 CSRF Token
2. 图片上传使用 Discourse 的官方 API
3. 所有事件处理器都有错误捕获和日志输出
4. 支持动态加载的编辑器（通过网络请求监听）

## 兼容性

- ✅ Linux.do
- ✅ Meta Discourse
- ✅ 其他 Discourse 论坛
- ✅ Chrome/Edge (Tampermonkey)
- ✅ Firefox (Greasemonkey/Tampermonkey)
- ✅ Safari (Userscripts)

## 后续优化建议

1. 添加图片上传进度提示
2. 支持多图片批量粘贴
3. 添加上传失败重试机制
4. 支持自定义图片插入格式
5. 添加图片压缩选项
